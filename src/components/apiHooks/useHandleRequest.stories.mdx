import { Meta } from '@storybook/addon-docs'
import { InternationalizationMessages } from '../../../.storybook/components'
import { useHandleRequest } from './useHandleRequest'

<Meta
  title="Components/APIHooks/useHandleRequest"
  component={useHandleRequest}
/>

# useHandleRequest

The `useHandleRequest` hook reduces the boilerplate code to handle a request against the backend.
It takes a request function and an optional success callback function as parameters.
The hook returns a function to fire the request and handle the error and intermediate state.

This component expects the following libraries to be installed:

```sh
npm i axios
```

### Parameter

| parameter                         | type                                            | description                                                        |
| --------------------------------- | ----------------------------------------------- | ------------------------------------------------------------------ |
| requestAction                     | `(parameters: Parameters) => Promise<Response>` | The function that makes the actual request against the backend.    |
| onSuccess                         | `(response: Response) => void`                  | The callback function after successful request.                    |
| options?.apiFallbackErrorMessage? | `string`                                        | Allows you to pass an optional message string for a general error. |

### Return value

| property        | type                                                                              | description                        |
| --------------- | --------------------------------------------------------------------------------- | ---------------------------------- |
| apiErrorMessage | <code>string &#124; null</code>                                                   | Error message of the API request.  |
| isRequesting    | `boolean`                                                                         | True while the request is pending. |
| onRequest       | <code>(parameters: Parameters) => Promise&lt;Response &#124; undefined&gt;</code> | Function to fire the request.      |

### Internationalization messages

<InternationalizationMessages items={['error.api']} />

## Usage

```tsx
import axios, { AxiosResponse } from 'axios'
import { useHandleRequest } from '@aboutbits/react-ui'
import { ReactElement } from 'react'

const deleteUser = axios.delete<void, AxiosResponse<void>>(
  'http://localhost:8080/users/1'
)

const onSuccess = () => {
  console.log('Success')
}

function DeleteUser(): ReactElement {
  const { apiErrorMessage, isRequesting, onRequest } = useHandleRequest(
    deleteUser,
    onSuccess
  )

  return (
    <>
      <button onClick={onRequest} disabled={isRequesting}>
        Delete User
      </button>
      {apiErrorMessage && <span>{apiErrorMessage}</span>}
    </>
  )
}
```

### With fallback error message

If you are not sure, whether the backend always returns the error message in an appropriate format, you can define a fallback message id.

```ts
import { useHandleRequest } from '@aboutbits/react-ui'
import axios, { AxiosResponse } from 'axios'

const deleteUser = axios.delete<void, AxiosResponse<void>>(
  'http://localhost:8080/users/1'
)

const onSuccess = () => {
  console.log('Success')
}

const { apiErrorMessage, isRequesting, onRequest } = useHandleRequest(
  deleteUser,
  onSuccess,
  {
    apiFallbackErrorMessage: 'Server error',
  }
)
```

### With parameters and without success callback

You can also pass parameters to the request function and omit the success callback.

```ts
import { useHandleRequest } from '@aboutbits/react-ui'
import axios, { AxiosResponse } from 'axios'

const validate = (formData: FormData) => {
  return axios.post<void, AxiosResponse<SuccessResponse>>(
    'http://localhost:8080/validate-form',
    formData
  )
}

const { apiErrorMessage, isRequesting, onRequest } = useHandleRequest(validate)

// ...

const result = await onRequest(formData)

if (result === undefined) {
  console.log('Error')
} else {
  console.log('Success', result.data) // result is of type AxiosResponse<SuccessResponse>
}
```
